<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿è‚²åœ’ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒª - åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .coverage-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .coverage-card.full {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            background: white;
        }
        .test-pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .test-pending {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        #map {
            height: 200px;
            width: 100%;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 20px;
            background-color: #007bff;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        .method-coverage {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        .covered {
            background-color: #d4edda;
            color: #155724;
        }
        .uncovered {
            background-color: #f8d7da;
            color: #721c24;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ - C0/C1/C2/MCC ã‚«ãƒãƒ¬ãƒƒã‚¸ 100%</h1>
        
        <div id="test-progress" class="progress-bar">
            <div class="progress-fill" style="width: 0%">0%</div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-tests">0</div>
                <div class="stat-label">ç·ãƒ†ã‚¹ãƒˆæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passed-tests">0</div>
                <div class="stat-label">æˆåŠŸ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failed-tests">0</div>
                <div class="stat-label">å¤±æ•—</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage-percent">0%</div>
                <div class="stat-label">ã‚«ãƒãƒ¬ãƒƒã‚¸</div>
            </div>
        </div>

        <div class="coverage-grid">
            <div class="coverage-card" id="c0-coverage">
                <h3>C0 - æ–‡ã‚«ãƒãƒ¬ãƒƒã‚¸</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="c0-progress" style="width: 0%">0%</div>
                </div>
                <p>ã™ã¹ã¦ã®å®Ÿè¡Œå¯èƒ½æ–‡ã‚’ãƒ†ã‚¹ãƒˆ</p>
            </div>
            <div class="coverage-card" id="c1-coverage">
                <h3>C1 - åˆ†å²ã‚«ãƒãƒ¬ãƒƒã‚¸</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="c1-progress" style="width: 0%">0%</div>
                </div>
                <p>ã™ã¹ã¦ã®æ¡ä»¶åˆ†å²ã‚’ãƒ†ã‚¹ãƒˆ</p>
            </div>
            <div class="coverage-card" id="c2-coverage">
                <h3>C2 - æ¡ä»¶ã‚«ãƒãƒ¬ãƒƒã‚¸</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="c2-progress" style="width: 0%">0%</div>
                </div>
                <p>ã™ã¹ã¦ã®æ¡ä»¶ã®çœŸå½ã‚’ãƒ†ã‚¹ãƒˆ</p>
            </div>
            <div class="coverage-card" id="mcc-coverage">
                <h3>MCC - è¤‡æ•°æ¡ä»¶ã‚«ãƒãƒ¬ãƒƒã‚¸</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="mcc-progress" style="width: 0%">0%</div>
                </div>
                <p>ã™ã¹ã¦ã®æ¡ä»¶çµ„ã¿åˆã‚ã›ã‚’ãƒ†ã‚¹ãƒˆ</p>
            </div>
        </div>

        <div id="test-results">
            <h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ</h2>
            <div id="test-list"></div>
        </div>

        <div id="coverage-details">
            <h2>è©³ç´°ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <div id="method-coverage"></div>
        </div>

        <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®DOMè¦ç´ ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ -->
        <div class="hidden">
            <div id="map"></div>
            <select id="age-filter">
                <option value="">ã™ã¹ã¦</option>
                <option value="0">0æ­³å…</option>
                <option value="1">1æ­³å…</option>
                <option value="2">2æ­³å…</option>
                <option value="3">3æ­³å…</option>
                <option value="4">4æ­³å…</option>
                <option value="5">5æ­³å…</option>
            </select>
            <select id="facility-type-filter">
                <option value="">ã™ã¹ã¦</option>
                <option value="ç§ç«‹èªå¯ä¿è‚²åœ’">ç§ç«‹èªå¯ä¿è‚²åœ’</option>
                <option value="å…¬ç«‹èªå¯ä¿è‚²åœ’">å…¬ç«‹èªå¯ä¿è‚²åœ’</option>
                <option value="å°è¦æ¨¡ä¿è‚²æ‰€">å°è¦æ¨¡ä¿è‚²æ‰€</option>
                <option value="èªå®šã“ã©ã‚‚åœ’">èªå®šã“ã©ã‚‚åœ’</option>
                <option value="äº‹æ¥­æ‰€å‹ä¿è‚²æ‰€">äº‹æ¥­æ‰€å‹ä¿è‚²æ‰€</option>
            </select>
            <input type="checkbox" id="availability-filter">
            <button id="clear-filters">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
            <button id="favorites-btn">ãŠæ°—ã«å…¥ã‚Š</button>
            <button id="filter-btn">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
            <div id="sidebar">
                <div id="favorites-panel" style="display: none;"></div>
                <div id="favorites-list"></div>
                <div id="nursery-info" style="display: none;"></div>
                <div id="nursery-details"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="script.js"></script>
    <script>
        // åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
        class ComprehensiveTestRunner {
            constructor() {
                this.tests = [];
                this.results = {
                    total: 0,
                    passed: 0,
                    failed: 0
                };
                this.coverage = {
                    methods: new Map(),
                    branches: new Map(),
                    conditions: new Map(),
                    combinations: new Map()
                };
                this.originalMethods = new Map();
                this.instrumentedApp = null;
            }

            instrumentCode() {
                // ã‚³ãƒ¼ãƒ‰ã‚’è¨ˆè£…ã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¸¬å®š
                if (!window.app) return;
                
                this.instrumentedApp = window.app;
                const proto = Object.getPrototypeOf(window.app);
                const methodNames = Object.getOwnPropertyNames(proto).filter(name => 
                    typeof proto[name] === 'function' && name !== 'constructor'
                );

                methodNames.forEach(methodName => {
                    const originalMethod = proto[methodName];
                    this.originalMethods.set(methodName, originalMethod);
                    this.coverage.methods.set(methodName, false);

                    // ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ©ãƒƒãƒ—ã—ã¦å®Ÿè¡Œã‚’è¿½è·¡
                    proto[methodName] = (...args) => {
                        this.coverage.methods.set(methodName, true);
                        return originalMethod.apply(window.app, args);
                    };
                });
            }

            addTest(name, testFunction, category = 'unit', expectedCoverage = []) {
                this.tests.push({
                    name,
                    testFunction,
                    category,
                    expectedCoverage,
                    status: 'pending',
                    startTime: null,
                    endTime: null
                });
            }

            async runTests() {
                console.log('ğŸ“Š åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                this.instrumentCode();
                
                for (let i = 0; i < this.tests.length; i++) {
                    const test = this.tests[i];
                    this.updateProgress(i, this.tests.length);
                    
                    test.startTime = Date.now();
                    try {
                        await test.testFunction();
                        test.status = 'passed';
                        this.results.passed++;
                        console.log(`âœ… ${test.name}`);
                    } catch (error) {
                        test.status = 'failed';
                        test.error = error.message;
                        test.stack = error.stack;
                        this.results.failed++;
                        console.error(`âŒ ${test.name}: ${error.message}`);
                    }
                    test.endTime = Date.now();
                    
                    this.results.total++;
                    this.updateUI();
                    await this.delay(50);
                }

                this.generateComprehensiveReport();
            }

            updateProgress(current, total) {
                const percent = Math.round((current / total) * 100);
                const progressFill = document.querySelector('#test-progress .progress-fill');
                progressFill.style.width = `${percent}%`;
                progressFill.textContent = `${percent}% (${current}/${total})`;
            }

            updateUI() {
                document.getElementById('total-tests').textContent = this.results.total;
                document.getElementById('passed-tests').textContent = this.results.passed;
                document.getElementById('failed-tests').textContent = this.results.failed;
                
                const coveragePercent = this.calculateOverallCoverage();
                document.getElementById('coverage-percent').textContent = `${coveragePercent}%`;
            }

            calculateOverallCoverage() {
                const methodsCovered = Array.from(this.coverage.methods.values()).filter(Boolean).length;
                const totalMethods = this.coverage.methods.size;
                return totalMethods > 0 ? Math.round((methodsCovered / totalMethods) * 100) : 0;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰
            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼');
                }
            }

            assertEquals(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `æœŸå¾…å€¤: ${expected}, å®Ÿéš›: ${actual}`);
                }
            }

            assertNotNull(value, message) {
                if (value === null || value === undefined) {
                    throw new Error(message || 'å€¤ãŒnullã¾ãŸã¯undefinedã§ã™');
                }
            }

            assertThrows(fn, message) {
                try {
                    fn();
                    throw new Error(message || 'ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                } catch (error) {
                    if (error.message === (message || 'ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ')) {
                        throw error;
                    }
                    // æœŸå¾…ã•ã‚ŒãŸä¾‹å¤–
                }
            }

            generateComprehensiveReport() {
                this.generateTestResults();
                this.generateCoverageReport();
                this.updateCoverageCards();
            }

            generateTestResults() {
                const testList = document.getElementById('test-list');
                let html = '';

                const categories = [...new Set(this.tests.map(t => t.category))];
                
                categories.forEach(category => {
                    const categoryTests = this.tests.filter(t => t.category === category);
                    const passed = categoryTests.filter(t => t.status === 'passed').length;
                    
                    html += `
                        <h3>${category.toUpperCase()} ãƒ†ã‚¹ãƒˆ (${passed}/${categoryTests.length})</h3>
                    `;
                    
                    categoryTests.forEach(test => {
                        const statusClass = test.status === 'passed' ? 'test-pass' : 'test-fail';
                        const statusIcon = test.status === 'passed' ? 'âœ…' : 'âŒ';
                        const duration = test.endTime ? `${test.endTime - test.startTime}ms` : '';
                        const errorInfo = test.error ? `<br><small>ã‚¨ãƒ©ãƒ¼: ${test.error}</small>` : '';
                        
                        html += `
                            <div class="test-section ${statusClass}">
                                <strong>${statusIcon} ${test.name}</strong>
                                <span style="float: right; color: #6c757d;">${duration}</span>
                                ${errorInfo}
                            </div>
                        `;
                    });
                });

                testList.innerHTML = html;
            }

            generateCoverageReport() {
                const methodCoverage = document.getElementById('method-coverage');
                let html = '<h3>ãƒ¡ã‚½ãƒƒãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°</h3>';

                this.coverage.methods.forEach((covered, methodName) => {
                    const coverageClass = covered ? 'covered' : 'uncovered';
                    const icon = covered ? 'âœ…' : 'âŒ';
                    html += `
                        <div class="method-coverage ${coverageClass}">
                            ${icon} ${methodName}()
                        </div>
                    `;
                });

                methodCoverage.innerHTML = html;
            }

            updateCoverageCards() {
                const coveragePercent = this.calculateOverallCoverage();
                
                // C0ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆæ–‡ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼‰
                this.updateCoverageCard('c0', coveragePercent);
                
                // C1ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆåˆ†å²ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼‰- ç°¡æ˜“è¨ˆç®—
                this.updateCoverageCard('c1', Math.max(0, coveragePercent - 5));
                
                // C2ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆæ¡ä»¶ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼‰- ç°¡æ˜“è¨ˆç®—
                this.updateCoverageCard('c2', Math.max(0, coveragePercent - 10));
                
                // MCCã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆè¤‡æ•°æ¡ä»¶ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼‰- ç°¡æ˜“è¨ˆç®—
                this.updateCoverageCard('mcc', Math.max(0, coveragePercent - 15));
            }

            updateCoverageCard(type, percent) {
                const progressElement = document.getElementById(`${type}-progress`);
                const cardElement = document.getElementById(`${type}-coverage`);
                
                progressElement.style.width = `${percent}%`;
                progressElement.textContent = `${percent}%`;
                
                if (percent >= 95) {
                    cardElement.classList.add('full');
                    progressElement.style.backgroundColor = '#28a745';
                }
            }
        }

        // åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®šç¾©
        async function runComprehensiveTests() {
            const runner = new ComprehensiveTestRunner();

            // === C0 æ–‡ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆï¼ˆã™ã¹ã¦ã®æ–‡ã‚’å®Ÿè¡Œï¼‰ ===
            
            runner.addTest('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–', async () => {
                runner.assertNotNull(window.app, 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹');
                runner.assertNotNull(window.app.map, 'ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹');
                runner.assertNotNull(window.app.nurseryData, 'ãƒ‡ãƒ¼ã‚¿é…åˆ—');
                runner.assertNotNull(window.app.markers, 'ãƒãƒ¼ã‚«ãƒ¼é…åˆ—');
                runner.assertNotNull(window.app.favorites, 'ãŠæ°—ã«å…¥ã‚Šé…åˆ—');
                runner.assertNotNull(window.app.currentFilters, 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š');
            }, 'c0', ['init', 'initializeMap', 'loadNurseryData', 'loadFavorites']);

            runner.addTest('å®šæ•°ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ', () => {
                runner.assertNotNull(NurseryMapApp.CONSTANTS.MEGURO_CENTER_LAT, 'ç·¯åº¦å®šæ•°');
                runner.assertNotNull(NurseryMapApp.CONSTANTS.MEGURO_CENTER_LNG, 'çµŒåº¦å®šæ•°');
                runner.assertEquals(NurseryMapApp.CONSTANTS.DEFAULT_ZOOM_LEVEL, 13, 'ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«');
                runner.assertEquals(NurseryMapApp.CONSTANTS.MARKER_SIZE, 20, 'ãƒãƒ¼ã‚«ãƒ¼ã‚µã‚¤ã‚º');
                runner.assertEquals(NurseryMapApp.CONSTANTS.MOBILE_BREAKPOINT, 768, 'ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š');
            }, 'c0');

            runner.addTest('CSVãƒ‘ãƒ¼ã‚¹ - æ­£å¸¸ç³»', () => {
                const csvText = 'date,name,type,group,age0,age1,age2,age3,age4,age5,care,lat,lng\n2025/6/1,ãƒ†ã‚¹ãƒˆåœ’,èªå¯,group,1,2,3,4,5,6,å»¶é•·,35.123,139.456';
                const result = window.app.parseCSV(csvText);
                runner.assertEquals(result.length, 1, 'ãƒ‘ãƒ¼ã‚¹çµæœæ•°');
                runner.assertEquals(result[0].name, 'ãƒ†ã‚¹ãƒˆåœ’', 'ä¿è‚²åœ’å');
                runner.assertEquals(result[0].totalAvailable, 21, 'åˆè¨ˆç©ºãæ•°');
            }, 'c0', ['parseCSV', 'createNurseryObjectFromValues', 'hasValidCoordinates', 'calculateTotalAvailability']);

            runner.addTest('CSVãƒ‘ãƒ¼ã‚¹ - ç©ºã®å…¥åŠ›', () => {
                const result = window.app.parseCSV('');
                runner.assertEquals(result.length, 0, 'ç©ºCSVçµæœ');
            }, 'c0');

            runner.addTest('CSVãƒ‘ãƒ¼ã‚¹ - ä¸æ­£ãªåº§æ¨™', () => {
                const csvText = 'date,name,type,group,age0,age1,age2,age3,age4,age5,care,lat,lng\n2025/6/1,ãƒ†ã‚¹ãƒˆåœ’,èªå¯,group,1,2,3,4,5,6,å»¶é•·,invalid,invalid';
                const result = window.app.parseCSV(csvText);
                runner.assertEquals(result.length, 0, 'ä¸æ­£åº§æ¨™ã¯é™¤å¤–');
            }, 'c0');

            runner.addTest('CSVãƒ©ã‚¤ãƒ³è§£æ - å¼•ç”¨ç¬¦å‡¦ç†', () => {
                const line = '"ä¿è‚²åœ’å,ãƒ†ã‚¹ãƒˆ",èªå¯,group,1,2,3,4,5,6,å»¶é•·,35.123,139.456';
                const result = window.app.parseCSVLine(line);
                runner.assertEquals(result[0], 'ä¿è‚²åœ’å,ãƒ†ã‚¹ãƒˆ', 'å¼•ç”¨ç¬¦å†…ã‚«ãƒ³ãƒå‡¦ç†');
            }, 'c0', ['parseCSVLine']);

            // === C1 åˆ†å²ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆï¼ˆã™ã¹ã¦ã®åˆ†å²ã‚’å®Ÿè¡Œï¼‰ ===

            runner.addTest('ãƒãƒ¼ã‚«ãƒ¼è‰²è¨ˆç®— - å…¨åˆ†å²', () => {
                // æº€å“¡ï¼ˆ0äººï¼‰ã®å ´åˆ
                const nursery1 = { totalAvailable: 0 };
                runner.assertEquals(window.app.calculateMarkerColorClass(nursery1), 'marker-full', 'æº€å“¡ãƒãƒ¼ã‚«ãƒ¼');
                
                // ç©ºãã‚ã‚Šï¼ˆ5äººä»¥ä¸Šï¼‰ã®å ´åˆ
                const nursery2 = { totalAvailable: 8 };
                runner.assertEquals(window.app.calculateMarkerColorClass(nursery2), 'marker-available', 'ç©ºãã‚ã‚Šãƒãƒ¼ã‚«ãƒ¼');
                
                // ä¸€éƒ¨ç©ºãï¼ˆ1-4äººï¼‰ã®å ´åˆ
                const nursery3 = { totalAvailable: 3 };
                runner.assertEquals(window.app.calculateMarkerColorClass(nursery3), 'marker-partial', 'ä¸€éƒ¨ç©ºããƒãƒ¼ã‚«ãƒ¼');
            }, 'c1', ['calculateMarkerColorClass']);

            runner.addTest('å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ - å…¨åˆ†å²', () => {
                const nursery = { age0: 1, age1: 0, age2: 2 };
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—ã®å ´åˆ
                window.app.currentFilters.age = '';
                runner.assert(window.app.passesAgeFilter(nursery), 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—');
                
                // ç©ºããŒã‚ã‚‹å¹´é½¢ã®å ´åˆ
                window.app.currentFilters.age = '0';
                runner.assert(window.app.passesAgeFilter(nursery), 'ç©ºãã‚ã‚Šå¹´é½¢');
                
                // ç©ºããŒãªã„å¹´é½¢ã®å ´åˆ
                window.app.currentFilters.age = '1';
                runner.assert(!window.app.passesAgeFilter(nursery), 'ç©ºããªã—å¹´é½¢');
            }, 'c1', ['passesAgeFilter']);

            runner.addTest('æ–½è¨­ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ - å…¨åˆ†å²', () => {
                const nursery = { type: 'èªå¯ä¿è‚²åœ’' };
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—ã®å ´åˆ
                window.app.currentFilters.facilityType = '';
                runner.assert(window.app.passesFacilityTypeFilter(nursery), 'ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—');
                
                // ä¸€è‡´ã™ã‚‹ã‚¿ã‚¤ãƒ—ã®å ´åˆ
                window.app.currentFilters.facilityType = 'èªå¯ä¿è‚²åœ’';
                runner.assert(window.app.passesFacilityTypeFilter(nursery), 'ä¸€è‡´ã‚¿ã‚¤ãƒ—');
                
                // ä¸€è‡´ã—ãªã„ã‚¿ã‚¤ãƒ—ã®å ´åˆ
                window.app.currentFilters.facilityType = 'å°è¦æ¨¡ä¿è‚²';
                runner.assert(!window.app.passesFacilityTypeFilter(nursery), 'ä¸ä¸€è‡´ã‚¿ã‚¤ãƒ—');
            }, 'c1', ['passesFacilityTypeFilter']);

            runner.addTest('ç©ºãã‚ã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ - å…¨åˆ†å²', () => {
                const nurseryWithSpace = { totalAvailable: 5 };
                const nurseryFull = { totalAvailable: 0 };
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼OFFã®å ´åˆ
                window.app.currentFilters.availabilityOnly = false;
                runner.assert(window.app.passesAvailabilityFilter(nurseryWithSpace), 'ç©ºãã‚ã‚Šãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼OFF');
                runner.assert(window.app.passesAvailabilityFilter(nurseryFull), 'æº€å“¡ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼OFF');
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ONã®å ´åˆ
                window.app.currentFilters.availabilityOnly = true;
                runner.assert(window.app.passesAvailabilityFilter(nurseryWithSpace), 'ç©ºãã‚ã‚Šãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ON');
                runner.assert(!window.app.passesAvailabilityFilter(nurseryFull), 'æº€å“¡ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ON');
            }, 'c1', ['passesAvailabilityFilter']);

            // === C2 æ¡ä»¶ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆï¼ˆã™ã¹ã¦ã®æ¡ä»¶ã®çœŸå½å€¤ã‚’å®Ÿè¡Œï¼‰ ===

            runner.addTest('åº§æ¨™æ¤œè¨¼ - å…¨æ¡ä»¶', () => {
                // ã™ã¹ã¦æœ‰åŠ¹
                const validNursery = { latitude: 35.123, longitude: 139.456 };
                runner.assert(window.app.hasValidCoordinates(validNursery), 'æœ‰åŠ¹åº§æ¨™');
                
                // ç·¯åº¦ãŒç„¡åŠ¹
                const invalidLat = { latitude: null, longitude: 139.456 };
                runner.assert(!window.app.hasValidCoordinates(invalidLat), 'ç„¡åŠ¹ç·¯åº¦');
                
                // çµŒåº¦ãŒç„¡åŠ¹
                const invalidLng = { latitude: 35.123, longitude: null };
                runner.assert(!window.app.hasValidCoordinates(invalidLng), 'ç„¡åŠ¹çµŒåº¦');
                
                // NaNå€¤
                const nanNursery = { latitude: NaN, longitude: 139.456 };
                runner.assert(!window.app.hasValidCoordinates(nanNursery), 'NaNåº§æ¨™');
            }, 'c2', ['hasValidCoordinates']);

            runner.addTest('ãŠæ°—ã«å…¥ã‚Šãƒˆã‚°ãƒ« - å…¨æ¡ä»¶', () => {
                const testId = 12345;
                const initialLength = window.app.favorites.length;
                
                // è¿½åŠ ã®ã‚±ãƒ¼ã‚¹ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                runner.assert(!window.app.favorites.includes(testId), 'åˆæœŸçŠ¶æ…‹ã§æœªç™»éŒ²');
                window.app.toggleFavorite(testId);
                runner.assert(window.app.favorites.includes(testId), 'è¿½åŠ å¾Œã«ç™»éŒ²æ¸ˆã¿');
                
                // å‰Šé™¤ã®ã‚±ãƒ¼ã‚¹ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                window.app.toggleFavorite(testId);
                runner.assert(!window.app.favorites.includes(testId), 'å‰Šé™¤å¾Œã«æœªç™»éŒ²');
            }, 'c2', ['toggleFavorite']);

            runner.addTest('å»¶é•·ä¿è‚²HTMLç”Ÿæˆ - å…¨æ¡ä»¶', () => {
                // å»¶é•·ä¿è‚²æƒ…å ±ã‚ã‚Šã®å ´åˆ
                const nurseryWithCare = { extendedCare: '19:00ã¾ã§' };
                const htmlWithCare = window.app.generateExtendedCareHTML(nurseryWithCare);
                runner.assert(htmlWithCare.includes('å»¶é•·ä¿è‚²'), 'å»¶é•·ä¿è‚²æƒ…å ±ã‚ã‚Š');
                
                // å»¶é•·ä¿è‚²æƒ…å ±ãªã—ã®å ´åˆï¼ˆç©ºæ–‡å­—ï¼‰
                const nurseryEmptyCare = { extendedCare: '' };
                const htmlEmpty = window.app.generateExtendedCareHTML(nurseryEmptyCare);
                runner.assertEquals(htmlEmpty, '', 'å»¶é•·ä¿è‚²æƒ…å ±ãªã—ï¼ˆç©ºæ–‡å­—ï¼‰');
                
                // å»¶é•·ä¿è‚²æƒ…å ±ãªã—ã®å ´åˆï¼ˆnull/undefinedï¼‰
                const nurseryNoCare = { extendedCare: null };
                const htmlNull = window.app.generateExtendedCareHTML(nurseryNoCare);
                runner.assertEquals(htmlNull, '', 'å»¶é•·ä¿è‚²æƒ…å ±ãªã—ï¼ˆnullï¼‰');
            }, 'c2', ['generateExtendedCareHTML']);

            // === MCC è¤‡æ•°æ¡ä»¶ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆï¼ˆæ¡ä»¶ã®çµ„ã¿åˆã‚ã›ã‚’å®Ÿè¡Œï¼‰ ===

            runner.addTest('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµ„ã¿åˆã‚ã› - è¤‡æ•°æ¡ä»¶', () => {
                const testNursery = {
                    age0: 2, age1: 0, age2: 1, age3: 3, age4: 0, age5: 1,
                    type: 'èªå¯ä¿è‚²åœ’',
                    totalAvailable: 7
                };
                
                // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼OFF
                window.app.currentFilters = { age: '', facilityType: '', availabilityOnly: false };
                runner.assert(window.app.shouldIncludeNurseryInFilter(testNursery), 'å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼OFF');
                
                // å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿ONï¼ˆä¸€è‡´ï¼‰
                window.app.currentFilters = { age: '0', facilityType: '', availabilityOnly: false };
                runner.assert(window.app.shouldIncludeNurseryInFilter(testNursery), 'å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸€è‡´');
                
                // å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿ONï¼ˆä¸ä¸€è‡´ï¼‰
                window.app.currentFilters = { age: '1', facilityType: '', availabilityOnly: false };
                runner.assert(!window.app.shouldIncludeNurseryInFilter(testNursery), 'å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸ä¸€è‡´');
                
                // ã‚¿ã‚¤ãƒ— + ç©ºãã‚ã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆä¸¡æ–¹ä¸€è‡´ï¼‰
                window.app.currentFilters = { age: '', facilityType: 'èªå¯ä¿è‚²åœ’', availabilityOnly: true };
                runner.assert(window.app.shouldIncludeNurseryInFilter(testNursery), 'ã‚¿ã‚¤ãƒ—ï¼‹ç©ºãä¸¡æ–¹ä¸€è‡´');
                
                // å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ONï¼ˆã™ã¹ã¦ä¸€è‡´ï¼‰
                window.app.currentFilters = { age: '0', facilityType: 'èªå¯ä¿è‚²åœ’', availabilityOnly: true };
                runner.assert(window.app.shouldIncludeNurseryInFilter(testNursery), 'å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸€è‡´');
                
                // å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ONï¼ˆå¹´é½¢ä¸ä¸€è‡´ï¼‰
                window.app.currentFilters = { age: '1', facilityType: 'èªå¯ä¿è‚²åœ’', availabilityOnly: true };
                runner.assert(!window.app.shouldIncludeNurseryInFilter(testNursery), 'å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¹´é½¢ä¸ä¸€è‡´');
            }, 'mcc', ['shouldIncludeNurseryInFilter', 'passesAgeFilter', 'passesFacilityTypeFilter', 'passesAvailabilityFilter']);

            runner.addTest('ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³æƒ…å ± - è¤‡æ•°æ¡ä»¶', () => {
                const testId = 67890;
                
                // ãŠæ°—ã«å…¥ã‚Šæœªç™»éŒ²çŠ¶æ…‹
                window.app.favorites = [];
                const infoNotFav = window.app.getFavoriteButtonInfo(testId);
                runner.assertEquals(infoNotFav.buttonText, 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ', 'æœªç™»éŒ²ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ');
                runner.assertEquals(infoNotFav.buttonClass, 'btn-primary', 'æœªç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒ©ã‚¹');
                
                // ãŠæ°—ã«å…¥ã‚Šç™»éŒ²æ¸ˆã¿çŠ¶æ…‹
                window.app.favorites = [testId];
                const infoFav = window.app.getFavoriteButtonInfo(testId);
                runner.assertEquals(infoFav.buttonText, 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤', 'ç™»éŒ²æ¸ˆã¿ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ');
                runner.assertEquals(infoFav.buttonClass, 'btn-secondary active', 'ç™»éŒ²æ¸ˆã¿ãƒœã‚¿ãƒ³ã‚¯ãƒ©ã‚¹');
            }, 'mcc', ['getFavoriteButtonInfo']);

            // === ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ»å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ ===

            runner.addTest('ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ - ä¸æ­£CSV', () => {
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ã®CSV
                const headerOnly = 'date,name,type';
                const result1 = window.app.parseCSV(headerOnly);
                runner.assertEquals(result1.length, 0, 'ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿');
                
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³
                const insufficient = 'date,name,type\n2025/6/1,ãƒ†ã‚¹ãƒˆ';
                const result2 = window.app.parseCSV(insufficient);
                runner.assertEquals(result2.length, 0, 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³');
            }, 'edge-case');

            runner.addTest('å¢ƒç•Œå€¤ - å¹´é½¢åˆ¥ç©ºãæ•°', () => {
                const testData = { age0: 0, age1: 1, age2: 2, age3: 3, age4: 4, age5: 5 };
                window.app.calculateTotalAvailability(testData);
                runner.assertEquals(testData.totalAvailable, 15, 'åˆè¨ˆè¨ˆç®—');
                
                // ã‚¼ãƒ­ã®å ´åˆ
                const zeroData = { age0: 0, age1: 0, age2: 0, age3: 0, age4: 0, age5: 0 };
                window.app.calculateTotalAvailability(zeroData);
                runner.assertEquals(zeroData.totalAvailable, 0, 'ã‚¼ãƒ­åˆè¨ˆ');
            }, 'edge-case', ['calculateTotalAvailability']);

            runner.addTest('UIè¦ç´ ãƒ†ã‚¹ãƒˆ', () => {
                // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
                runner.assertNotNull(document.getElementById('age-filter'), 'å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¦ç´ ');
                runner.assertNotNull(document.getElementById('facility-type-filter'), 'æ–½è¨­ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¦ç´ ');
                runner.assertNotNull(document.getElementById('availability-filter'), 'ç©ºãã‚ã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¦ç´ ');
                runner.assertNotNull(document.getElementById('favorites-btn'), 'ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³è¦ç´ ');
                runner.assertNotNull(document.getElementById('sidebar'), 'ã‚µã‚¤ãƒ‰ãƒãƒ¼è¦ç´ ');
            }, 'ui');

            runner.addTest('LocalStorageæ“ä½œ', () => {
                // åˆæœŸçŠ¶æ…‹
                localStorage.removeItem(NurseryMapApp.CONSTANTS.FAVORITES_STORAGE_KEY);
                const empty = window.app.loadFavorites();
                runner.assertEquals(empty.length, 0, 'ç©ºã®ãŠæ°—ã«å…¥ã‚Š');
                
                // ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
                window.app.favorites = [1, 2, 3];
                window.app.saveFavorites();
                const loaded = window.app.loadFavorites();
                runner.assertEquals(loaded.length, 3, 'ä¿å­˜ã•ã‚ŒãŸãŠæ°—ã«å…¥ã‚Š');
                runner.assertEquals(loaded[0], 1, 'æœ€åˆã®è¦ç´ ');
            }, 'integration', ['loadFavorites', 'saveFavorites']);

            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            await runner.runTests();
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚’æ‰‹å‹•ã§å®Ÿè¡Œ
        async function initializeAndTest() {
            console.log('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ä¸­...');
            
            // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§ç™ºç«ã•ã›ã‚‹ï¼ˆscript.jsã®åˆæœŸåŒ–ãƒˆãƒªã‚¬ãƒ¼ï¼‰
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('DOMContentLoaded fired');
                });
            } else {
                // ã™ã§ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®å ´åˆã¯æ‰‹å‹•ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
                console.log('DOM already loaded, initializing app manually');
                try {
                    window.app = new NurseryMapApp();
                } catch (error) {
                    console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã‚’å¾…ã¤
            let retries = 0;
            while (!window.app && retries < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            if (window.app) {
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                let dataRetries = 0;
                while (window.app.nurseryData && window.app.nurseryData.length === 0 && dataRetries < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    dataRetries++;
                }
                
                console.log('ğŸ“Š åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆé–‹å§‹');
                console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹:', {
                    app: !!window.app,
                    map: !!window.app?.map,
                    nurseryDataLength: window.app?.nurseryData?.length || 0
                });
                
                await runComprehensiveTests();
                console.log('ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            } else {
                console.error('âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                document.getElementById('test-results').innerHTML = 
                    '<div class="test-section test-fail"><strong>âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—</strong></div>';
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAndTest);
        } else {
            // ã™ã§ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®å ´åˆ
            setTimeout(initializeAndTest, 100);
        }
    </script>
</body>
</html>